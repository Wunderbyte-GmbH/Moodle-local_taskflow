{"version":3,"file":"dashboard.min.js","sources":["../src/dashboard.js"],"sourcesContent":["/**\n * JS for handling AJAX-based form step loading.\n *\n * @module local_taskflow/dashboard\n * @copyright 2025\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n// import Ajax from 'core/ajax';\nimport * as notification from 'core/notification';\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport DynamicForm from 'core_form/dynamicform';\n\nconst SELECTORS = {\n    DASHBOARDWRAPPER: '[data-region=\"dashboard-wrapper\"]',\n    USERSELECTORFORM: '[data-region=\"tf-selectuserformcontainer\"]',\n    LISTBOX: '.form-autocomplete-selection',\n    CLOSEBTN: '.btn-close-tab',\n};\n\nvar container;\nvar uniqueid;\nvar dynamicForm;\n\n/**\n *\n * @param {*} id\n */\nexport const init = (id) => {\n    // eslint-disable-next-line no-console\n    console.log('Initializing dashboard with uniqueid:', uniqueid);\n    const body = document.body;\n    uniqueid = id;\n    container = document.querySelector(SELECTORS.DASHBOARDWRAPPER + '[data-uniqueid=\"' + uniqueid + '\"]');\n    attachCloseListenerOnce();\n    if (!body.classList.contains('dashboard-init')) {\n        //loadDashboard(uniqueid)\n               initUserSelectorForm();\n            return;\n\n    }\n    body.classList.add('dashboard-init');\n};\n\n/**\n * Init the user selector form.\n *\n */\nfunction initUserSelectorForm() {\n\n    const element = document.querySelector(SELECTORS.USERSELECTORFORM);\n    if (!element || element.dataset.init) {\n        // eslint-disable-next-line no-console\n        console.warn('No user selector form found for uniqueid:', uniqueid);\n        return;\n    }\n    // Initialize the form.\n    dynamicForm = new DynamicForm(\n        element,\n        'local_taskflow\\\\form\\\\dynamic_select_users'\n    );\n\n    dynamicForm.load()\n        // Wait until the autocomplete list-box exists.\n        .then(() => waitForElement(container, SELECTORS.LISTBOX))\n        .then(listBox => {\n            reactToChange(listBox);\n            const observer = new MutationObserver(() =>\n                reactToChange(listBox, {dynamicForm, uniqueid})\n            );\n            observer.observe(listBox, {childList: true, subtree: true});\n\n            dynamicForm.addEventListener(dynamicForm.events.FORM_SUBMITTED, (e) => {\n                // Prevent default form submission.\n                e.preventDefault();\n                e.stopPropagation();\n                loadDashboard(uniqueid)\n                .then((status) => {\n                    if (status === 'redirected') {\n                        return;\n                    }\n                    initUserSelectorForm();\n                    return;\n                })\n                .catch((err) => {\n                    // eslint-disable-next-line no-console\n                    console.error('Dashboard failed:', err);\n                });\n             });\n        })\n        .catch(notification.exception);\n\n    element.dataset.init = '1';\n\n}\n\n/**\n * Bind exactly once to the <ul class=\"nav nav-tabs\"> inside the wrapper.\n * Everything else happens only if the click was on .btn-close-tab.\n */\nfunction attachCloseListenerOnce() {\n    const wrapper = document.querySelector(\n        `${SELECTORS.DASHBOARDWRAPPER}[data-uniqueid=\"${uniqueid}\"]`\n    );\n    const navTabs = wrapper?.querySelector('.nav.nav-tabs');\n    if (!navTabs || navTabs.dataset.closeInit) {\n        return;\n    }\n\n    navTabs.addEventListener('click', (e) => {\n        const btn = e.target.closest('.btn-close-tab');\n        if (!btn) {\n            return;\n        }\n\n        e.preventDefault();\n        e.stopPropagation();\n\n        const userid = Number(btn.dataset.userid);\n        if (!userid) {\n            return;\n        }\n\n        // 1. Purge cache via AJAX.\n        Ajax.call([{\n            methodname: 'local_taskflow_clear_dashboard_cache',\n            args: {userid},\n        }])[0]\n        .done(() => {\n            // 2. Remove tab + pane.\n            const tab = document.querySelector(btn.dataset.tab);\n            const pane = document.querySelector(btn.dataset.pane);\n            if (pane) {\n                pane.remove();\n            }\n            if (tab) {\n                const li = tab.parentElement;\n                const wasActive = tab.classList.contains('active');\n                li.remove();\n\n                if (wasActive) {\n                    const first = wrapper.querySelector('.nav-link');\n                    if (first) {\n                        first.click();\n                    }\n                }\n            }\n        })\n        .fail(notification.exception);\n    });\n\n    navTabs.dataset.closeInit = '1';\n}\n\n/**\n * Wait for an element to be added to the DOM.\n * @param {*} root\n * @param {*} selector\n * @param {*} timeout\n * @returns\n */\nfunction waitForElement(root, selector, timeout = 1000) {\n    return new Promise((resolve, reject) => {\n        const el = root.querySelector(selector);\n        if (el) {\n            return resolve(el);\n        }\n\n        const obs = new MutationObserver(() => {\n            const candidate = root.querySelector(selector);\n            if (candidate) {\n                obs.disconnect();\n                resolve(candidate);\n            }\n        });\n\n        obs.observe(root, {childList: true, subtree: true});\n\n        // Safety-net timeout\n        setTimeout(() => {\n            obs.disconnect();\n            reject(new Error(`Element ${selector} not found within ${timeout} ms`));\n        }, timeout);\n    });\n}\n\n/**\n * Check if a selection exists in the listbox.\n * @returns {boolean}\n */\nfunction selectionExists() {\n    const selBox = container.querySelector('.form-autocomplete-selection');\n    // A real selection produces a <span … class=\"badge …\"> inside the listbox\n    return !!selBox && selBox.querySelector('.badge');\n}\n\n/**\n * React to changes in the listbox selection.\n * @param {*} listBox\n */\nfunction reactToChange(listBox) {\n    if (selectionExists(listBox)) {\n        if (dynamicForm) {\n            dynamicForm.submitFormAjax()\n                .catch(notification.exception);\n        }\n    }\n}\n\n\n/**\n * Load a step of the form via AJAX.\n *\n * @param {mixed} uniqueid\n *\n * @return void *\n */\nfunction loadDashboard(uniqueid) {\n  const multiformcontainer = document.querySelector(\n    SELECTORS.DASHBOARDWRAPPER + '[data-uniqueid=\"' + uniqueid + '\"]'\n  );\n  if (!multiformcontainer) {\n    return Promise.resolve(false);\n  }\n\n  return new Promise((resolve, reject) => {\n    Ajax.call([\n      {\n        methodname: 'local_taskflow_load_dashboard',\n        args: {},\n        done: (response) => {\n            if (response.returnurl?.length) {\n                window.location.href = response.returnurl;\n                resolve('redirected');\n                return;\n            }\n\n            Templates.renderForPromise(\n            response.template,\n            JSON.parse(response.data)\n            )\n            .then(({ html, js }) => {\n                html += response.js;\n                Templates.replaceNode(\n                    `${SELECTORS.DASHBOARDWRAPPER}[data-uniqueid=\"${uniqueid}\"]`,\n                    html,\n                    js\n              );\n                document.body.classList.add('dashboard-init');\n                resolve(true);\n                return true;\n            })\n            .catch((err) => {\n                // eslint-disable-next-line no-console\n                console.error(err);\n                reject(err);\n            });\n        },\n\n        fail: (xhrError) => {\n          notification.exception(xhrError);\n          reject(xhrError);\n        },\n      },\n    ]);\n  });\n}\n"],"names":["_interopRequireDefault","e","__esModule","default","_getRequireWildcardCache","WeakMap","r","t","notification","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","_interopRequireWildcard","_ajax","_templates","_dynamicform","SELECTORS","container","uniqueid","dynamicForm","initUserSelectorForm","element","document","querySelector","dataset","init","DynamicForm","load","then","root","selector","timeout","arguments","length","undefined","Promise","resolve","reject","el","obs","MutationObserver","candidate","disconnect","observe","childList","subtree","setTimeout","Error","waitForElement","listBox","reactToChange","addEventListener","events","FORM_SUBMITTED","preventDefault","stopPropagation","multiformcontainer","Ajax","methodname","args","done","response","returnurl","window","location","href","Templates","renderForPromise","template","JSON","parse","data","_ref","html","js","replaceNode","body","classList","add","catch","err","console","error","fail","xhrError","exception","loadDashboard","status","warn","selBox","selectionExists","submitFormAjax","_exports","id","log","wrapper","navTabs","closeInit","btn","target","closest","userid","Number","tab","pane","remove","li","parentElement","wasActive","contains","first","click","attachCloseListenerOnce"],"mappings":"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"}