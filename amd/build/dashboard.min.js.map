{"version":3,"file":"dashboard.min.js","sources":["../src/dashboard.js"],"sourcesContent":["/**\n * JS for handling AJAX-based form step loading.\n *\n * @module local_taskflow/dashboard\n * @copyright 2025\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n// import Ajax from 'core/ajax';\nimport * as notification from 'core/notification';\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport DynamicForm from 'core_form/dynamicform';\n\nconst SELECTORS = {\n    DASHBOARDWRAPPER: '[data-region=\"dashboard-wrapper\"]',\n    USERSELECTORFORM: '[data-region=\"tf-selectuserformcontainer\"]',\n    LISTBOX: '.form-autocomplete-selection',\n    CLOSEBTN: '.btn-close-tab',\n};\n\nvar container;\nvar uniqueid;\nvar dynamicForm;\n\n/**\n *\n * @param {*} id\n */\nexport const init = (id) => {\n    // eslint-disable-next-line no-console\n    console.log('Initializing dashboard with uniqueid:', uniqueid);\n    const body = document.body;\n    uniqueid = id;\n    container = document.querySelector(SELECTORS.DASHBOARDWRAPPER + '[data-uniqueid=\"' + uniqueid + '\"]');\n    attachCloseListenerOnce();\n    if (!body.classList.contains('dashboard-init')) {\n        loadDashboard(uniqueid, 'asd')\n        .then((status) => {\n            if (status === 'redirected') {\n                return;\n            }\n            initUserSelectorForm();\n            return;\n        })\n        .catch((err) => {\n            // eslint-disable-next-line no-console\n            console.error('Dashboard failed:', err);\n        });\n    }\n    body.classList.add('dashboard-init');\n};\n\n/**\n * Init the user selector form.\n *\n */\nfunction initUserSelectorForm() {\n\n    const element = document.querySelector(SELECTORS.USERSELECTORFORM);\n\n    // Initialize the form.\n    dynamicForm = new DynamicForm(\n        element,\n        'local_taskflow\\\\form\\\\dynamic_select_users'\n    );\n\n    dynamicForm.load()\n        // Wait until the autocomplete list-box exists.\n        .then(() => waitForElement(container, SELECTORS.LISTBOX))\n        .then(listBox => {\n            reactToChange(listBox);\n            const observer = new MutationObserver(() =>\n                reactToChange(listBox, {dynamicForm, uniqueid})\n            );\n            observer.observe(listBox, {childList: true, subtree: true});\n\n            dynamicForm.addEventListener(dynamicForm.events.FORM_SUBMITTED, (e) => {\n                // Prevent default form submission.\n                e.preventDefault();\n                loadDashboard(uniqueid, 'asd')\n                .then((status) => {\n                    if (status === 'redirected') {\n                        return;\n                    }\n                    initUserSelectorForm();\n                    return;\n                })\n                .catch((err) => {\n                    // eslint-disable-next-line no-console\n                    console.error('Dashboard failed:', err);\n                });\n             });\n        })\n        .catch(notification.exception);\n\n}\n\n/**\n * Bind exactly once to the <ul class=\"nav nav-tabs\"> inside the wrapper.\n * Everything else happens only if the click was on .btn-close-tab.\n */\nfunction attachCloseListenerOnce() {\n    const wrapper = document.querySelector(\n        `${SELECTORS.DASHBOARDWRAPPER}[data-uniqueid=\"${uniqueid}\"]`\n    );\n    const navTabs = wrapper?.querySelector('.nav.nav-tabs');\n    if (!navTabs || navTabs.dataset.closeInit) {\n        return;\n    }\n\n    navTabs.addEventListener('click', (e) => {\n        const btn = e.target.closest('.btn-close-tab');\n        if (!btn) {\n            return;\n        }\n\n        e.preventDefault();\n        e.stopPropagation();\n\n        const userid = Number(btn.dataset.userid);\n        if (!userid) {\n            return;\n        }\n\n        // 1. Purge cache via AJAX.\n        Ajax.call([{\n            methodname: 'local_taskflow_clear_dashboard_cache',\n            args: {userid},\n        }])[0]\n        .done(() => {\n            // 2. Remove tab + pane.\n            const tab = document.querySelector(btn.dataset.tab);\n            const pane = document.querySelector(btn.dataset.pane);\n            if (pane) {\n                pane.remove();\n            }\n            if (tab) {\n                const li = tab.parentElement;\n                const wasActive = tab.classList.contains('active');\n                li.remove();\n\n                if (wasActive) {\n                    const first = wrapper.querySelector('.nav-link');\n                    if (first) {\n                        first.click();\n                    }\n                }\n            }\n        })\n        .fail(notification.exception);\n    });\n\n    navTabs.dataset.closeInit = '1';\n}\n\n/**\n * Wait for an element to be added to the DOM.\n * @param {*} root\n * @param {*} selector\n * @param {*} timeout\n * @returns\n */\nfunction waitForElement(root, selector, timeout = 31000) {\n    return new Promise((resolve, reject) => {\n        const el = root.querySelector(selector);\n        if (el) {\n            return resolve(el);\n        }\n\n        const obs = new MutationObserver(() => {\n            const candidate = root.querySelector(selector);\n            if (candidate) {\n                obs.disconnect();\n                resolve(candidate);\n            }\n        });\n\n        obs.observe(root, {childList: true, subtree: true});\n\n        // Safety-net timeout\n        setTimeout(() => {\n            obs.disconnect();\n            reject(new Error(`Element ${selector} not found within ${timeout} ms`));\n        }, timeout);\n    });\n}\n\n/**\n * Check if a selection exists in the listbox.\n * @returns {boolean}\n */\nfunction selectionExists() {\n    const selBox = container.querySelector('.form-autocomplete-selection');\n    // A real selection produces a <span … class=\"badge …\"> inside the listbox\n    return !!selBox && selBox.querySelector('.badge');\n}\n\n/**\n * React to changes in the listbox selection.\n * @param {*} listBox\n */\nfunction reactToChange(listBox) {\n    if (selectionExists(listBox)) {\n        if (dynamicForm) {\n            dynamicForm.submitFormAjax()\n                .catch(notification.exception);\n        }\n    }\n}\n\n\n/**\n * Load a step of the form via AJAX.\n *\n * @param {mixed} uniqueid\n * @param {mixed} filter\n *\n * @return void *\n */\nfunction loadDashboard(uniqueid, filter) {\n  const multiformcontainer = document.querySelector(\n    SELECTORS.DASHBOARDWRAPPER + '[data-uniqueid=\"' + uniqueid + '\"]'\n  );\n  if (!multiformcontainer) {\n    return Promise.resolve(false);\n  }\n\n  return new Promise((resolve, reject) => {\n    Ajax.call([\n      {\n        methodname: 'local_taskflow_load_dashboard',\n        args: { uniqueid: uniqueid, call: filter },\n\n        done: (response) => {\n            if (response.returnurl?.length) {\n                window.location.href = response.returnurl;\n                resolve('redirected');\n                return;\n            }\n\n            Templates.renderForPromise(\n            response.template,\n            JSON.parse(response.data)\n            )\n            .then(({ html, js }) => {\n                html += response.js;\n                Templates.replaceNode(\n                    `${SELECTORS.DASHBOARDWRAPPER}[data-uniqueid=\"${uniqueid}\"]`,\n                    html,\n                    js\n              );\n                document.body.classList.add('dashboard-init');\n                resolve(true);\n                return true;\n            })\n            .catch((err) => {\n                // eslint-disable-next-line no-console\n                console.error(err);\n                reject(err);\n            });\n        },\n\n        fail: (xhrError) => {\n          notification.exception(xhrError);\n          reject(xhrError);\n        },\n      },\n    ]);\n  });\n}\n"],"names":["SELECTORS","container","uniqueid","dynamicForm","initUserSelectorForm","element","document","querySelector","DynamicForm","load","then","root","selector","timeout","Promise","resolve","reject","el","obs","MutationObserver","candidate","disconnect","observe","childList","subtree","setTimeout","Error","waitForElement","listBox","reactToChange","addEventListener","events","FORM_SUBMITTED","e","preventDefault","loadDashboard","status","catch","err","console","error","notification","exception","selBox","selectionExists","submitFormAjax","filter","call","methodname","args","done","response","returnurl","_response$returnurl","length","window","location","href","renderForPromise","template","JSON","parse","data","_ref","html","js","replaceNode","body","classList","add","fail","xhrError","id","log","wrapper","navTabs","dataset","closeInit","btn","target","closest","stopPropagation","userid","Number","tab","pane","remove","li","parentElement","wasActive","contains","first","click","attachCloseListenerOnce"],"mappings":"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"}